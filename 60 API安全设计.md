## API 安全设计

##### 1	高并发限流：令牌桶算法和漏桶算法

**令牌桶算法**：按照固定速率往桶中添加令牌，请求是否被处理需要看桶中令牌是否足够，当令牌数减为零时则拒绝新的请

求；

**漏桶算法**：按照常量固定速率流出请求，流入请求速率任意，当流入的请求数累积到漏桶容量时，则新流入的请求被

拒绝；

令牌桶限制的是平均流入速率（允许突发请求，只要有令牌就可以处理，支持一次拿3个令牌，4个令牌），并允许一定程

度突发流量；

漏桶限制的是常量流出速率（即流出速率是一个固定常量值，比如都是1的速率流出，而不能一次是1，下次又是2），从

而平滑突发流入速率；

令牌桶允许一定程度的突发，而漏桶主要目的是平滑流入速率；

#### 2	CDN（阿里云）加速：

DNS即Domain Name System，是域名解析服务的意思。它在互联网的作用是：把域名转换成为网络可以识别的ip地址。

人们习惯记忆域名，但机器间互相只认IP地址，域名与IP地址之间是一一对应的，它们之间的转换工作称为域名解析，域

名解析需要由专门的域名解析服务器来完成，整个过程是自动进行的。

CDN加速意思就是在用户和我们的服务器之间加一个缓存机制,动态获取IP地址根据地理位置，让用户到最近的服务器访

问。

#### 3	如何破解模拟请求：

Token 图形验证码 黑白名单 核心接口使用发送验证码 图形识别 来验证

#### 4	防盗链如何实现：

 判断http请求头Referer域中的记录来源的值，如果和当前访问的域名不一致的情况下，说明该图片可能被其他服务器盗用。

#### 5	Api幂等性如何实现：使用Token+Redis，防止重复提交。

如何防止暴力找回密码？

1，验证码 不要使用纯数字

2，建议验证码使用 数字+字母 混合使用。

3，找回密码五次或者三次以上还是错误（出现图形验证码）

4，配置防止DDOS,限流，限制ip访问，配置黑名单和白名单。

#### 6	上传文件漏洞格式服务器硬盘：

1，通过判断文件流的方式确定文件的格式。不要通过判断后缀的方式判断文件格式。

2，将静态资源和动态资源分离，使用nginx+tomcat实现动静分离。

3，服务器端不能做删除操作。

4，对文件格式进行校验，前端跟服务器都要进行校验（前端校验扩展名，服务器校验扩展名、Content_Type等）。

5，服务器上不要开启热部署。

6，限制上传class、jsp、exe等可执行程序。

#### 7	常见的安全问题：

Web常见的攻击手段与防御：

XXS，CSRF，上传漏洞，sql注入，忘记密码漏洞，以及其他漏洞。

XXS 脚本攻击，使用过滤器拦截敏感信息，将参数特殊字符转换成html源代码保存。

可能会受到XSS脚本注入，读取本地cookie远程发送给黑客服务器端，或者跳转到钓鱼网站。

保证接口幂等性：使用token+图形验证码（防止机器识别），没有一家公司可以百分之百破解验证码。

CSRF模拟请求: 核心业务接口，最好使用发送验证码、人脸识别、指纹识别。

#### 8	如何设计一套API接口

接口权限（开放性问题 开放平台 OAuth2.0协议 开放接口|内部接口），

幂等性问题，

安全性问题（Https），

防止篡改数据(验证签名)，

使用网关拦截接口实现黑名单和白名单

接口使用http协议+json格式restful风格，目的为了跨平台，

考虑高并发，对接口实现保护，服务降级熔断隔离，

最后使用统一的的API接口平台swagger。

#### 9	如何保证外网接口的安全性：

1，设置IP网关接口访问权限。

2，开放平台设计遵循oauth2.0协议

3，采用https加密传输协议（使用nginx配置https)

4，api接口数字签名（移动端接口）

5，基于令牌实现api接口调用，基于AccessToken实现Api调用。

#### 10	Oauth2.0认证：

流程：

1 第一步：用户同意授权，获取code

2 第二步：通过code换取网页授权access_token

3 第三步：刷新access_token（如果需要）

4 第四步：拉取用户信息(需scope为 snsapi_userinfo)

#### 11	URL中的特殊字符处理：

使用URLEncoder.encode和decode 转码和解码。

#### 12	RPC远程调用的过程中，保证安全性针对数据加密。

数据为什么要加密：防止别人抓包分析http请求，获取明文数据篡改请求。

#### 13	Https与Http区别

1）HTTPS的服务器需要到CA申请证书，以证明自己服务器的用途；

2）HTTP信息是明文传输，HTTPS信息是密文传输；

3）HTTP与HTTPS的端口不同，一个是80端口，一个是443端口；

可以说HTTP与HTTPS是完全不同的连接方式，HTTPS集合了加密传输，身份认证，更加的安全。

在微信小程序里面都限制只能有https协议、搜索引擎排名都对https优先收录

#### 14	Https加密过程：

1）客户端请求服务器，发送握手消息

2）服务器返回客户端自己的加密算法、数字证书和公钥；

3）客户端验证服务器端发送来的数字证书是否与本地受信任的证书相关信息一致；如果不一致则客户端浏览器提示证书

不安全如下图所示

如果验证通过，则浏览器会采用自身的随机数算法产生一个随机数，并用服务器发送来的公钥加密；发送给服务器；这里

如果有人通过攻击获取了这个消息，那也没用，因为他没有解密此段消息所需要私钥；验证通过的网站在浏览器地址栏的

右边会有一安全锁的标识；

4）服务器解密得到此随机数，并用此随机数作为密钥采用对称加密算法加密一段握手消息发送给浏览器；

5）浏览器收到消息后解密成功，则握手结束，后续的信息都通过此随机密钥加密传输。

以上是服务端认证的情况，如果服务端对访问的客户端也有认证需求，则客户端也需要将自己的证书发送给服务器，服务

器认证不通过，通讯结束；原理同上；

另外，一般在传输过程中为了防止消息窜改，还会采用消息摘要后再加密的方式，以此保证消息传递的正确性